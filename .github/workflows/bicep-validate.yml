name: Bicep Validate

on:
  pull_request:
    branches: [main]
    paths:
      - '**.bicep'
      - 'bicepconfig.json'
      - 'parameters/**.example'

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  BICEP_VERSION: '0.32.4'

jobs:
  validate:
    name: Lint → Validate → What-If
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Bicep CLI
        run: |
          az bicep install --version v${{ env.BICEP_VERSION }}
          az bicep version

      - name: Lint
        run: az bicep lint --file main.bicep

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Validate
        run: |
          az deployment group validate \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file main.bicep \
            --parameters parameters/main.bicepparam

      - name: What-If
        id: whatif
        run: |
          az deployment group what-if \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file main.bicep \
            --parameters parameters/main.bicepparam \
            --no-pretty-print > whatif-output.txt 2>&1 || true
          cat whatif-output.txt

      - name: Comment What-If on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('whatif-output.txt', 'utf8');
            const truncated = output.length > 60000 ? output.substring(0, 60000) + '\n\n... (truncated)' : output;

            const body = `## Bicep What-If Results\n\n\`\`\`\n${truncated}\n\`\`\`\n\n*Generated by [bicep-validate](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.includes('## Bicep What-If Results'));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
